# chrono-C 2D 機能拡張ロードマップ

本ドキュメントは `chrono-C-all` における 2D 機能を Chrono C++ 本家のカバレッジへ近づけるための設計指針と進捗管理をまとめたものです。以降、作業が進むたびにこのファイルを更新します。

## 1. ゴール定義
- 2D 剛体・拘束・接触機能を Chrono-main と同等レベルまで移植し、最終的に 2D シミュレーションを `chrono-C-all` 単体で完結できるようにする。
- テスト（単体・回帰）を充実させ、将来の改修によるリグレッションを防止する。
- 最小限のインフラ（Makefile、CI スクリプト）で自動テストを回せる体制を整え、開発効率を確保する。

## 2. 現状サマリ（2025-10-19 時点）
| 領域 | ステータス | 備考 |
|------|------------|------|
| 剛体基盤 (`chrono_body2d`) | ✅ 初期機能あり | 明示的オイラー積分、ワールド/ローカル変換、円形形状対応済み。スリープや多形状未対応。 |
| 距離制約 (`chrono_constraint2d`) | ✅ 安定化 solver あり | Baumgarte + Softness + Warm-start。複数制約や角速度連成未実装。 |
| 接触 (`chrono_collision2d`) | ✅ 円vs円（反発のみ） | 接線摩擦・継続接触管理は未実装。位置補正は単純。 |
| テスト | ⚠️ 部分的 | 距離制約収束テスト、円衝突回帰テスト（正面・斜め・静止）あり。摩擦関連テストは未整備。 |
| ドキュメント | ⚠️ 一部整備 | README に単体テストの手順あり。本ドキュメントを起点に設計情報を蓄積。 |

## 3. 機能拡張ロードマップ
### 3.1 剛体
1. **質量特性拡張**  
   - 慣性テンソル更新ロジック（2D 版）を追加し、任意形状に対応できるようにする。  
   - `chrono_body2d_set_mass_properties` の実装とテスト。
2. **積分器拡張**  
   - セミインプリシット・サブステップなどを導入。`chrono_body2d_integrate_semi_implicit` 等の API を検討。
3. **スリープ/ウェイク管理**  
   - 速度閾値と時間閾値を導入し、アイドルなボディを休止状態へ移行。

### 3.2 拘束
1. **抽象インターフェース化**  
   - `ChronoConstraint2DInterface`（関数テーブル）を追加し、複数拘束を扱えるよう統合管理。  
   - **設計メモ（2025-10-19 更新）**  
     - 共通構造体 `ChronoConstraint2DOps_C` に `prepare`, `warm_start`, `solve_velocity`, `solve_position` の関数ポインタを保持。  
     - ボディ参照やアンカーポイントなどの共有データを `ChronoConstraint2DBase_C` にまとめ、各拘束型はこれを先頭メンバとして含む。  
     - 初期化関数で ops を設定し、既存 API (`chrono_distance_constraint2d_prepare` 等) は ops 呼び出しに委譲する薄いラッパーへ移行して後方互換を維持。  
     - 拘束配列を処理する `chrono_constraint2d_batch_solve(...)` を追加し、Sequential Impulse 風に反復できるよう設計。  
     - 将来的な並列化を見据え、バッチ構造には拘束グループ ID（アイランド）を保持できる拡張余地を残す。
2. **新規拘束タイプ**  
   - 回転ジョイント（ピン）、スライダ、スプリングダンパ等を段階的に追加。
3. **ソルバー**  
   - Sequential Impulse / Gauss-Seidel による複合拘束解決。  
   - Baumgarte 以外の安定化手法（位置校正、XPBD 的アプローチ）の検討。

### 3.3 接触
1. **接線摩擦・接線方向インパルス**  
   - クーロン摩擦モデルの実装と回帰テスト。  
   - スリープ解除や粘着処理フラグの検討。
2. **継続接触管理**  
   - マンifold（複数接触点）の保持、ウォームスタート用蓄積インパルス管理。
3. **形状拡張**  
   - 凸ポリゴン対応：SAT or GJK/EPA の簡易実装。  
   - 円 vs ポリゴン、ボックス vs ボックスなどをサポート。
4. **アイランドソルバーの導入**  
   - 拘束・接触をまとめたアイランド分割と並列実行への布石。

### 3.4 テスト & ツール
1. **単体テスト整備**  
   - 各拘束・接触ケースの数値回帰テストを `tests/` 以下に追加。  
   - `make test` で全テストが実行されるよう連携。
2. **ベンチマーク/デモ**  
   - パフォーマンス検証用のベンチスイートを整備し、改善効果を把握。
3. **CI 連携**  
   - GitHub Actions 等でテスト自動実行（ローカルでの再現性重視、後日CI環境を検討）。

## 4. マイルストンとタスク一覧
| フェーズ | 想定期間 | 主タスク | 成果物 | 進捗 |
|----------|----------|----------|----------|------|
| Phase 1: テスト基盤強化 | 1-2 週間 | 既存テスト拡張、`make test` 整備、リグレッションテスト追加 | テストスイート、ログ | ✅ （正面/斜め/静止接触テスト追加。摩擦テストが残作業） |
| Phase 2: 拘束インターフェース化 | 2-3 週間 | 距離拘束の共通化、ピンジョイント追加 | `chrono_constraint2d` 拡張、テスト | ⏳ |
| Phase 3: 接触摩擦対応 | 2-3 週間 | 接触摩擦、接線方向処理、接触継続管理 | `chrono_collision2d` 拡張、回帰テスト | ⏳ |
| Phase 4: 形状/ソルバー強化 | 3-4 週間 | 凸形状衝突、Sequential Impulse、アイランド処理 | 拘束/接触統合ソルバー | ⏳ |
| Phase 5: 最終統合・ドキュメント | 1-2 週間 | ドキュメント整備、ベンチ、CI 準備 | README 更新、設計ドキュメント | ⏳ |

## 5. 進捗トラッキング
- **最新更新日**: 2025-10-19
- **完了済みハイライト**
  - 明示的距離拘束テスト (`test_distance_constraint_stabilization`) 自動化。
  - 円衝突回帰テスト (`test_circle_collision_regression`) 追加。
  - 円衝突斜め回帰テスト (`test_circle_collision_oblique`) 追加し、摩擦ゼロ時の接線速度保存を検証。
  - 円衝突静止回帰テスト (`test_circle_collision_resting`) 追加し、ゼロ相対速度での安定性を確認。
- **次のアクション候補**
  1. 拘束インターフェース抽象化案をプロトタイプとして実装し、距離拘束を新フレームワークへ移行。
  2. 摩擦導入時のテストケース設計（静摩擦・動摩擦の境界）と必要なソルバー拡張の検討。

## 6. 参考資料・メモ
- Chrono-main (C++) の関連ソース：`ChBody`, `ChLink`, `ChContactContainer` 等
- 既存の 3D 実装を参考にする際は、データ構造と API レイヤに差異があるため抽象化設計を先に行うこと。
- 接触摩擦導入時は数値発散を避けるため、テストを細分化しベータ版段階での回帰テストを徹底する。

---
※ 本ドキュメントは進捗に応じて逐次更新します。更新時は「最新更新日」と該当セクションの内容を明確に変更してください。
