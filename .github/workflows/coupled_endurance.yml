name: Coupled Endurance Maintenance

on:
  schedule:
    - cron: '15 3 * * 1'
  workflow_dispatch:

jobs:
  archive-and-summarize:
    runs-on: ubuntu-latest
    env:
      ARCHIVE_MAX_ENTRIES: 26
      ARCHIVE_MAX_AGE_DAYS: 90
      ARCHIVE_MAX_FILE_SIZE_MB: 25
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install tooling dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install matplotlib requests

      - name: Archive endurance CSV logs
        run: |
          EXTRA_ARGS=""
          if [ -n "${ARCHIVE_MAX_ENTRIES:-}" ]; then
            EXTRA_ARGS="$EXTRA_ARGS --max-entries ${ARCHIVE_MAX_ENTRIES}"
          fi
          if [ -n "${ARCHIVE_MAX_AGE_DAYS:-}" ]; then
            EXTRA_ARGS="$EXTRA_ARGS --max-age-days ${ARCHIVE_MAX_AGE_DAYS}"
          fi
          if [ -n "${ARCHIVE_MAX_FILE_SIZE_MB:-}" ]; then
            EXTRA_ARGS="$EXTRA_ARGS --max-file-size-mb ${ARCHIVE_MAX_FILE_SIZE_MB}"
          fi
          python tools/archive_coupled_constraint_endurance.py \
            --archive-dir data/endurance_archive \
            --manifest data/endurance_archive/manifest.json \
            --label "${{ github.workflow }}:${{ github.run_id }}" \
            --prune-duplicates \
            --plan-csv data/endurance_archive/plan.csv \
            --plan-markdown data/endurance_archive/plan.md \
            $EXTRA_ARGS

      - name: Generate endurance summaries
        run: |
          python tools/plot_coupled_constraint_endurance.py \
            data/endurance_archive/latest.csv \
            --output data/endurance_archive/latest.png \
            --dpi 160 \
            --no-show \
            --summary-md data/endurance_archive/latest.summary.md \
            --summary-html data/endurance_archive/latest.summary.html \
            --summary-json data/endurance_archive/latest.summary.json \
            --fail-on-max-condition 5.0e8 \
            --fail-on-rank-ratio 0.05

      - name: Validate latest.summary schema
        run: |
          python tools/validate_latest_summary_schema.py \
            --summary-json data/endurance_archive/latest.summary.json \
            --output-markdown data/endurance_archive/latest.summary.validation.md \
            --output-json data/endurance_archive/latest.summary.validation.json \
            --fail-on-error

      - name: Trim endurance CSV columns
        run: |
          set -euo pipefail
          shopt -s nullglob
          for csv in data/endurance_archive/*.csv; do
            name=$(basename "$csv")
            if [ "$name" = "plan.csv" ]; then
              continue
            fi
            python tools/filter_coupled_endurance_log.py "$csv" --drop-step
          done

      - name: Summarize archive failure rate
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python tools/report_archive_failure_rate.py \
            --repo "${{ github.repository }}" \
            --workflow coupled_endurance.yml \
            --job-name archive-and-summarize \
            --weeks 8 \
            --output-chart data/endurance_archive/archive_failure_rate.png \
            --output-slack data/endurance_archive/archive_failure_rate_slack.json \
            --output-json data/endurance_archive/archive_failure_rate.json

      - name: Prepare notification payloads
        env:
          JOB_STATUS: ${{ job.status }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          python tools/compose_endurance_notification.py \
            --summary-json data/endurance_archive/latest.summary.json \
            --plan-markdown data/endurance_archive/plan.md \
            --summary-validation-report data/endurance_archive/latest.summary.validation.md \
            --run-id ${{ github.run_id }} \
            --run-url "$RUN_URL" \
            --status "$JOB_STATUS" \
            --artifact-name coupled-endurance-${{ github.run_id }} \
            --output-slack data/endurance_archive/notification_slack.json \
            --output-email data/endurance_archive/notification_email.txt

      - name: Upload endurance artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coupled-endurance-${{ github.run_id }}
          path: |
            data/endurance_archive/latest.csv
            data/endurance_archive/latest.png
            data/endurance_archive/latest.summary.md
            data/endurance_archive/latest.summary.html
            data/endurance_archive/latest.summary.json
            data/endurance_archive/latest.summary.validation.md
            data/endurance_archive/latest.summary.validation.json
            data/endurance_archive/plan.csv
            data/endurance_archive/plan.md
            data/endurance_archive/notification_slack.json
            data/endurance_archive/notification_email.txt
            data/endurance_archive/archive_failure_rate.png
            data/endurance_archive/archive_failure_rate.json
            data/endurance_archive/archive_failure_rate_slack.json
            data/endurance_archive/manifest.json
            data/endurance_archive/*.csv
            data/endurance_archive/*.csv.summary.md
            data/endurance_archive/*.csv.summary.html
            data/endurance_archive/*.csv.summary.json
            data/endurance_archive/repro/**

      - name: Send webhook notification
        if: always()
        env:
          WEBHOOK_URL: ${{ secrets.ENDURANCE_ALERT_WEBHOOK }}
          JOB_STATUS: ${{ job.status }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [ -z "${WEBHOOK_URL}" ]; then
            echo "WEBHOOK_URL not set; skipping notification."
            exit 0
          fi
          payload=$(cat data/endurance_archive/notification_slack.json)
          curl -X POST -H 'Content-Type: application/json' --data "$payload" "$WEBHOOK_URL"

      - name: Send failure-rate digest
        if: always()
        env:
          WEBHOOK_URL: ${{ secrets.ENDURANCE_ALERT_WEBHOOK }}
        run: |
          if [ -z "${WEBHOOK_URL}" ]; then
            echo "WEBHOOK_URL not set; skipping failure-rate digest."
            exit 0
          fi
          if [ ! -f data/endurance_archive/archive_failure_rate_slack.json ]; then
            echo "Failure-rate Slack payload missing; skipping."
            exit 0
          fi
          payload=$(cat data/endurance_archive/archive_failure_rate_slack.json)
          curl -X POST -H 'Content-Type: application/json' --data "$payload" "$WEBHOOK_URL"

      - name: Print email notification draft
        if: always()
        run: |
          echo "--- Coupled Endurance email notification ---"
          cat data/endurance_archive/notification_email.txt

      - name: Generate repro command (fallback)
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          mkdir -p data/endurance_archive/repro
          COMMENT_OPTS=""
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            COMMENT_OPTS="--post-comment --comment-target pr/${{ github.event.pull_request.number }}"
          fi
          if [ "${{ github.event_name }}" = "issues" ]; then
            COMMENT_OPTS="--post-comment --comment-target issue/${{ github.event.issue.number }}"
          fi
          COMMENT_OPTS="$COMMENT_OPTS --console-comment-only"
          python tools/fetch_endurance_artifact.py \
            ${{ github.run_id }} \
            --output-dir data/endurance_archive/repro \
            --summary-out data/endurance_archive/repro/latest.summary.json \
            --comment-file data/endurance_archive/repro/comment.md \
            --repo "${REPO}" \
            --max-retries 3 \
            $COMMENT_OPTS
          echo "--- Coupled Endurance repro comment ---"
          cat data/endurance_archive/repro/comment.md
